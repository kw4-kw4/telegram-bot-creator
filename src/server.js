const express = require('express'); const dotenv = require('dotenv'); const bodyParser = require('body-parser'); const { Telegraf } = require('telegraf'); const { addBot, getBots, getBotByName, deleteBot, getBotCommands } = require('./database');  dotenv.config();  const app = express(); const PORT = process.env.PORT || 3000;  // Хранилище для активных ботов const activeBots = new Map();  app.use(bodyParser.json()); app.use(express.static('public'));  // Инициализация ботов из базы данных при запуске const initializeBots = async () => {   try {     const bots = await new Promise((resolve, reject) => {       getBots((err, rows) => {         if (err) reject(err);         else resolve(rows);       });     });      for (const botData of bots) {       if (botData.is_active) {         try {           const bot = new Telegraf(botData.token);           setupBotHandlers(bot, botData.id);           bot.launch();           activeBots.set(botData.name, { bot, id: botData.id });           console.log(`Бот ${botData.name} запущен`);         } catch (error) {           console.error(`Ошибка запуска бота ${botData.name}:`, error.message);         }       }     }   } catch (error) {     console.error('Ошибка инициализации ботов:', error.message);   } };  // Настройка обработчиков для бота const setupBotHandlers = (bot, botId) => {   // Обработчик команды /start   bot.start(async (ctx) => {     try {       const commands = await new Promise((resolve, reject) => {         getBotCommands(botId, (err, rows) => {           if (err) reject(err);           else resolve(rows);         });       });        const startCommand = commands.find(cmd => cmd.command === 'start');       if (startCommand) {         ctx.reply(startCommand.response);       } else {         ctx.reply('Привет! Я бот, созданный через веб-приложение!');       }     } catch (error) {       console.error('Ошибка получения команд бота:', error.message);       ctx.reply('Произошла ошибка при обработке команды');     }   });    // Обработчик текстовых сообщений   bot.on('text', async (ctx) => {     try {       const commands = await new Promise((resolve, reject) => {         getBotCommands(botId, (err, rows) => {           if (err) reject(err);           else resolve(rows);         });       });        const messageText = ctx.message.text.toLowerCase();       const command = commands.find(cmd => cmd.command === messageText);        if (command) {         ctx.reply(command.response);       } else {         ctx.reply('Команда не найдена. Используйте /start для начала работы.');       }     } catch (error) {       console.error('Ошибка обработки сообщения:', error.message);       ctx.reply('Произошла ошибка при обработке сообщения');     }   }); };  // Создание нового бота app.post('/api/bots', (req, res) => {   const { token, name } = req.body;    if (!token || !name) {     return res.status(400).json({ error: 'Требуются токен и имя бота' });   }    addBot(name, token, (err, botId) => {     if (err) {       if (err.message.includes('UNIQUE constraint failed')) {         return res.status(400).json({ error: 'Бот с таким именем уже существует' });       }       return res.status(500).json({ error: 'Ошибка при сохранении бота в базу данных' });     }      try {       const bot = new Telegraf(token);       setupBotHandlers(bot, botId);       bot.launch();       activeBots.set(name, { bot, id: botId });        res.json({ success: true, message: `Бот ${name} успешно создан и запущен` });     } catch (error) {       // Удаляем бота из базы данных, если не удалось запустить       deleteBot(name, () => {});       res.status(500).json({ error: 'Ошибка при создании бота: ' + error.message });     }   }); });  // Получение списка ботов app.get('/api/bots', (req, res) => {   getBots((err, bots) => {     if (err) {       return res.status(500).json({ error: 'Ошибка при получении списка ботов' });     }     res.json({ bots: bots.map(bot => ({ id: bot.id, name: bot.name, is_active: bot.is_active })) });   }); });  // Остановка бота app.delete('/api/bots/:name', (req, res) => {   const { name } = req.params;   const botData = activeBots.get(name);    if (!botData) {     return res.status(404).json({ error: 'Бот не найден или не активен' });   }    try {     botData.bot.stop();     activeBots.delete(name);      deleteBot(name, (err, changes) => {       if (err) {         return res.status(500).json({ error: 'Ошибка при удалении бота из базы данных' });       }        res.json({ success: true, message: `Бот ${name} остановлен` });      });   } catch (error) {     res.status(500).json({ error: 'Ошибка при остановке бота: ' + error.message });   } });  // Добавление команды для бота app.post('/api/bots/:name/commands', (req, res) => {   const { name } = req.params;   const { command, response } = req.body;    if (!command || !response) {     return res.status(400).json({ error: 'Требуются команда и ответ' });   }    getBotByName(name, (err, bot) => {     if (err || !bot) {       return res.status(404).json({ error: 'Бот не найден' });     }      addBotCommand(bot.id, command, response, (err, commandId) => {       if (err) {         return res.status(500).json({ error: 'Ошибка при добавлении команды' });       }       res.json({ success: true, message: `Команда ${command} добавлена для бота ${name}`, commandId });     });   }); });  // Получение команд бота app.get('/api/bots/:name/commands', (req, res) => {   const { name } = req.params;    getBotByName(name, (err, bot) => {     if (err || !bot) {       return res.status(404).json({ error: 'Бот не найден' });     }      getBotCommands(bot.id, (err, commands) => {       if (err) {         return res.status(500).json({ error: 'Ошибка при получении команд' });       }       res.json({ commands });     });   }); });  app.listen(PORT, async () => {   console.log(`Сервер запущен на порту ${PORT}`);   await initializeBots(); });